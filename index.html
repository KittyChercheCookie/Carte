<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --panel-width:380px;
      --brand:#B77C3B;
      --brand-strong:#B77C3B;
      --muted:#6b7280;
      --bg:#ffffff;
      --star-gold:#F59E0B;
      --star-grey:#D1D5DB;
      --card-radius:12px;
      --popover-z:6000;
      --font-ui: "Bahnschrift Condensed","Bahnschrift","Barlow Condensed","Arial Narrow",Arial,sans-serif;
      --font-size: 14px;
      --mark-low:  #D0DBE2;  
      --mark-mid:  #fad993; 
      --mark-mid2:  #b7e087;
      --mark-high: #28bda9; 
      --logo-col: clamp(110px, 30vw, 42vw); 
      --mobile-gap: 8px;
    }

    .leaflet-marker-icon.highlight { filter: none !important; transform: translateY(-1px) scale(1.05); }
    .leaflet-marker-icon.highlight.dimmed { opacity: 1 !important; filter: drop-shadow(0 0 8px var(--brand)) saturate(1.15) !important; }
       
    /* Uniformiser la police et la taille des boutons (prend le dessus) */
    button,
    .btn,
    #filters .actions button {
      font-family: var(--font-ui) !important;
      font-size: var(--font-size) !important;
      line-height: 1.25; /* optionnel, pour garder le m√™me rendu */
    }

    #filters .actions,
#search .actions{
  display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:stretch; margin-top:4px;
}
#search .actions button{
  border:0; background:var(--brand); color:#fff; padding:6px ; border-radius:8px; font-size:13px; cursor:pointer;
}
#filters .actions button:hover,
#search .actions button:hover{ background:var(--brand-strong); }
#filters .actions .reset,
#search .actions .reset{ background:#f3f4f6; color:#111827; }
#filters .actions .reset:hover,
#search .actions .reset:hover{ background:#e5e7eb; }

    /* Global */
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{
      height:100%; margin:0;
      font-family: var(--font-ui);
      font-size: var(--font-size);
      overflow-x:hidden;
      scroll-behavior:smooth;
    }

    
    /* Assure-toi que les composants cl√©s h√©ritent bien */
    .btn,
    .ms-trigger,
    .ms-panel,
    .ms-opt,
    .ms-head,
    .token,
    .ac-item,
    label,
    input,
    select,
    textarea,
    .leaflet-popup-content,
    .leaflet-container {
      font-family: inherit !important;
      font-size: inherit;
}

    /* Map full screen */
    #map{ position:fixed; inset:0; z-index:0; }

    /* Title (desktop) */
    .titlechip{
      position:absolute; z-index:1000; left:12px; top:8px;
      padding:8px 12px; border-radius:10px;
      font-size:14px; font-weight:600;
      max-width:calc(100vw - 24px);
    }

    /* Left column (desktop) */
    #leftUI{
      position:absolute; left:12px; top:100px; width:255px;
      display:grid; gap:10px; z-index:1001; overflow:visible;
    }

    /* Cards */
    .card{
      width:100%; max-width:100%;
      background:#F6ECDF; border:1px solid #B77C3B; border-radius:var(--card-radius);
      box-shadow:0 8px 24px rgba(0,0,0,.08);
      padding:12px; display:grid; gap:10px; position:relative;
      overflow:visible;
      z-index:1;
      transition:max-height .25s ease, opacity .2s ease, border-width .2s ease, padding .2s ease;
    }
    .card.raise{ z-index:calc(var(--popover-z) - 1); }
    .card.collapsed{ max-height:0!important; padding-top:0; padding-bottom:0; border-width:0; opacity:0; overflow:hidden; box-shadow:none; }
    .card:not(.collapsed) { overflow:visible !important; }

    /* CTA rows */
    .cta-row{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      flex:1 1 0; min-width:0; max-width:100%;
      border:0; background:var(--brand); color:#fff;
      padding:10px 12px; border-radius:8px; font-size:13px; cursor:pointer;
      text-decoration:none; text-align:center; white-space:normal; word-break:break-word; line-height:1.25;
    }
    .btn:hover{ background:var(--brand-strong); }
    .btn-outline{ background:#fff; border:1px solid #e5e7eb; color:#111827; }
    .btn-small{ font-size:12px; padding:8px 10px; }
    .btn-tab{ flex:1; border:1px solid #e5e7eb; background:#fff; color:#111827; }
    .btn-tab.active{ background:var(--brand); color:#fff; border-color:var(--brand); }

    /* Titles */
    #search.card h3, #filters.card h3{ margin:0 0 6px; font-size:14px; }

    /* Search card */
    .tokenbox{ position:relative; }
    .tokenlist{ display:flex; gap:6px; flex-wrap:wrap; margin-bottom:6px; }
    .token{
      background:#F6ECDF; color:var(--brand); border:1px solid #c7dcff; border-radius:999px; padding:4px 8px; font-size:12px;
      display:inline-flex; align-items:center; gap:6px;
    }
    .token .x{ cursor:pointer; }
    .ac-list{
      position:absolute; left:0; right:0; top:100%; z-index:5;
      background:#fff; border:1px solid #e5e7eb; border-radius:10px;
      box-shadow:0 8px 24px rgba(0,0,0,.18); max-height:240px; overflow:auto; display:none;
      -webkit-overflow-scrolling:touch;
    }
    .ac-item{ padding:8px 10px; cursor:pointer; }
    .ac-item:hover{ background:#f3f4f6; }
    #search input[type="text"]{
      width:100%; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; font-size:14px; background:#fff;
    }
    .token-actions{ display:flex; justify-content:flex-end; margin-top:8px; }
    .btn-clear{
      background:#f3f4f6; color:#111827; border:1px solid #e5e7eb;
      padding:6px 8px; border-radius:8px; font-size:12px; cursor:pointer;
    }
    .btn-clear:hover{ background:#e5e7eb; }

    /* Filters card */
    #filters{ position:relative; z-index:1; overflow:visible; }
    #filters .row{ display:grid; gap:6px; }
    #filters input[type="text"]{ width:100%; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; font-size:14px; }

    /* Filters body */
    #filters-body{ position:relative; display:grid; gap:12px; overflow:visible !important; }

    /* Sliders */
        /* Track g√©n√©ral */
        input[type="range"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
          width: 100%;
          height: 6px;
          background: #e5e7eb; /* gris clair de fond */
          border-radius: 999px;
          outline: none;
        }

        /* Chrome & Safari */
        input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 18px;
          height: 18px;
          border-radius: 50%;
          background: var(--brand); /* couleur du bouton */
          border: 2px solid #fff;
          box-shadow: 0 0 0 2px var(--brand);
          margin-top: -6px;
          cursor: pointer;
        }

        /* Chrome & Safari: Progress */
        input[type="range"]::-webkit-slider-runnable-track {
          height: 6px;
          border-radius: 999px;
          background: linear-gradient(var(--brand), var(--brand)) 0% 0% / 0% 100% no-repeat, #e5e7eb;
        }

        /* Firefox */
        input[type="range"]::-moz-range-track {
          height: 6px;
          border-radius: 999px;
          background: #e5e7eb;
        }
        input[type="range"]::-moz-range-progress {
          background-color: var(--brand);
          height: 6px;
          border-radius: 999px;
        }
        input[type="range"]::-moz-range-thumb {
          width: 18px;
          height: 18px;
          border-radius: 50%;
          background: var(--brand);
          border: 2px solid #fff;
          box-shadow: 0 0 0 2px var(--brand);
          cursor: pointer;
        }

        /* IE / Edge */
        input[type="range"]::-ms-track {
          width: 100%;
          height: 6px;
          background: transparent;
          border-color: transparent;
          color: transparent;
        }
        input[type="range"]::-ms-fill-lower {
          background: var(--brand);
          border-radius: 999px;
        }
        input[type="range"]::-ms-fill-upper {
          background: #e5e7eb;
          border-radius: 999px;
        }
        input[type="range"]::-ms-thumb {
          width: 18px;
          height: 18px;
          border-radius: 50%;
          background: var(--brand);
          border: 2px solid #fff;
          box-shadow: 0 0 0 2px var(--brand);
          cursor: pointer;
        }

    /* Multi-selects */
    .multiselect{ position:relative; overflow:visible; }
    .ms-trigger{
      display:flex; justify-content:space-between; align-items:center; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; cursor:pointer; background:#fff;
    }
    .ms-panel{
      position:absolute; left:0; right:0; top:calc(100% + 6px); z-index:1001;
      background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.18);
      padding:8px; display:none; max-height:300px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .multiselect.open { z-index: 1000; }
    .multiselect.open .ms-panel{ display:block; }
    .ms-head{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px; font-size:12px; color:var(--muted); }
    .ms-head .link{ color:var(--brand); cursor:pointer; }
    .ms-opt{ display:flex; align-items:center; gap:8px; padding:6px 4px; font-size:14px; }
    .ms-count{ color:var(--muted); font-size:12px; }

    /* Actions row */
    #filters .actions{ display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:stretch; margin-top:4px; }
    #filters .actions button{ border:0; background:var(--brand); color:#fff; padding:10px 12px; border-radius:8px; font-size:13px; cursor:pointer; }
    #filters .actions button:hover{ background:var(--brand-strong); }
    #filters .actions .reset{ background:#f3f4f6; color:#111827; }
    #filters .actions .reset:hover{ background:#e5e7eb; }

    /* Lock overlay ‚Äî FULL SIZE of the filters card */
    #filters.locked #filters-body{ pointer-events:none; }
    #filters-overlay{
      display:none; position:absolute; inset:0;
      background:rgba(31,41,55,.12); z-index:9; border-radius:var(--card-radius);
      backdrop-filter:blur(1px); align-items:center; justify-content:center; text-align:center; padding:14px;
    }
    #filters.locked #filters-overlay{ display:flex; }
    .overlay-card{
      background:#fff; color:#111827; border-radius:10px; padding:10px 12px; box-shadow:0 6px 18px rgba(0,0,0,.12);
      font-size:14px; line-height:1.35; display:inline-flex; align-items:center; gap:8px;
    }

    /* Side panel (desktop right / mobile bottom sheet) */
    #panel{
      position:absolute; right:0; top:0; height:100%; width:var(--panel-width);
      background:#fff; box-shadow:-8px 0 24px rgba(0,0,0,.08);
      transform:translateX(100%); transition:transform .25s ease; z-index:1100; display:flex; flex-direction:column; pointer-events:none;
    }
    #panel.active{ transform:translateX(0); pointer-events:auto; }
    #panel header{ padding:16px 18px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:10px; }
    #panel header h2{ margin:0; font-size:18px; line-height:1.2; }
    #panel header .close{ margin-left:auto; border:0; background:#f3f4f6; width:32px; height:32px; border-radius:8px; cursor:pointer; font-size:18px; }
    #panel .body{ padding:14px 18px; overflow-y:auto; -webkit-overflow-scrolling:touch; touch-action:pan-y; }
    .meta{ color:#6b7280; font-size:13px; display:grid; gap:4px; margin:6px 0 12px; }
    .pill{ display:inline-block; background:#f3f4f6; color:#B77C3B; font-size:12px; padding:4px 8px; border-radius:999px; margin-right:6px; }
    .section-title{ font-weight:600; margin:14px 0 8px; }

    /* =Personnalisation du PANEL mobile */
   @media (max-width:768px){
  .multiselect.inline-mobile .ms-trigger{
    display:none;                 /* on masque le "header" cliquable */
  }
  .multiselect.inline-mobile .ms-panel{
    position: static;             /* plus de panneau flottant */
    display: block !important;    /* toujours visible */
    max-height: none;             
    box-shadow: none;
    border: 0;
    padding: 0;                   /* look plus "int√©gr√©" √† la carte */
  }
  
    #ms-food {
    padding: 5px 12px;        /* espace int√©rieur (haut/bas, gauche/droite) */
    border: 1px solid #ddd;    /* bordure grise */
    border-radius: 10px;       /* coins arrondis */
    background: #ffffff;          /* fond blanc (ou #F6ECDF pour beige) */
    font-size: 14px;           /* texte global √† l'int√©rieur */
  }
  #ms-food .ms-trigger{
    display: none !important;
  }
  #ms-food .ms-panel{
    position: static !important;
    display: block !important;
    max-height: none !important;
    box-shadow: none !important;
    border: 0 !important;
    padding: 0 !important;
  }
  #ms-food .ms-head {
    font-size: 14px !important;     /* taille comme sur desktop */
    font-weight: 600;               /* plus lisible */
    color: #111827;                 /* couleur texte principale */
    margin-bottom: 8px;             /* un peu d‚Äôespace en dessous */
    padding :6px
  }
  #filters.raise{ box-shadow: none !important; }
  #ms-food.multiselect{ z-index: auto !important; }


    /* Le cadre autour du label + curseur */
  #filters .sliderrow{
    padding: 10px 12px;          /* espace int√©rieur */
    border: 1px solid #ddd;      /* bordure */
    border-radius: 10px;         /* coins arrondis */
    background: #fff;            /* fond (align√© avec Cat√©gorie) */
    font-size: 14px;             /* texte lisible */
    margin-bottom: 10px;         /* espace sous le cadre */
  }

  /* Le label "Note minimale" dans le cadre */
  #filters .sliderrow #lbl-rating{
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #111827;
  }

  /* Organisation du curseur + valeur */
  #filters .sliderrow .sliderwrap{
    display: grid;
    grid-template-columns: 1fr auto; /* curseur / valeur */
    align-items: center;
    gap: 10px;
  }

  /* Renforce la lisibilit√© de la valeur (‚â• 0 ‚òÖ) */
  #filters .sliderrow #f-rating-val{
    font-weight: 600;
  }

  /* Optionnel : m√™me ‚Äúa√©ration‚Äù horizontale que Cat√©gorie */
  #ms-food,                       /* encadr√© Cat√©gorie */
  #filters .sliderrow{            /* encadr√© Note minimale */
    box-sizing: border-box;
  }
    /* Bottom-sheet panel : plus haut sur mobile */
  #panel{
    position: fixed;
    left: 0; right: 0; bottom: 0; top: 0;
    width: 100vw;
    max-width: 100vw;
    height: 40dvh !important;                     
    max-height: calc(100dvh - env(safe-area-inset-top, 0px) - 8px);
    transform: translateY(100%);
    box-shadow: 0 -8px 24px rgba(0,0,0,.12);
    border-top-left-radius: 14px;
    border-top-right-radius: 14px;
  }
  #panel.active{ transform: translateY(0); }

  /* Un peu moins de padding pour gagner de la place */
  #panel header{ padding: 10px 12px; }
  #panel .body{ padding: 10px 12px; }

    #search.card:not(.collapsed){
    min-height: 10dvh;   /* hauteur minimale r√©duite */
    max-height: 40dvh;   /* garde un plafond */
    display: grid;
    grid-template-rows: auto 1fr;
  }

  /* Filtres : conserve la taille plus haute */
  #filters.card:not(.collapsed){
    min-height: auto !important;
    max-height: none !important;
    display: block !important; 
    grid-template-rows: auto 1fr;
  }

  /* Le contenu interne devient scrollable, pas toute la page */
  #search .tokenbox,
  #filters #filters-body{
    overflow: visible !important;     /* pas de scroll interne */
    min-height: 0 !important;
  }

  /* Optionnel : un peu plus d‚Äôair dans les cartes sur mobile */
  #search.card:not(.collapsed),
  #filters.card:not(.collapsed){
    padding-top: 14px;
    padding-bottom: 14px;
  }

      /* Panneau mobile : titre + cat√©gories c√¥te √† c√¥te dans le header */
      #panel header{
        display: flex;
        align-items: center;
        flex-wrap: wrap;   /* autorise un retour √† la ligne si manque de place */
        gap: 6px;
      }
      #panel header #p-title{
        font-size: 14px;   /* ajuste si besoin */
        line-height: 1.0;
        margin: 0;
      }
      #panel header #p-pills{
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin: 0;
      }
      #panel header #p-pills .pill{
        font-size: 11px;
        padding: 3px 6px;
      }
      /* Si jamais un #p-pills restait dans le body, on le masque sur mobile */
      #panel .body #p-pills{ display: none !important; }

      /* --- Sous-titre "Posts Instagram" --- */
      .section-title {
        font-size: 13px;       /* plus petit */
        font-weight: 500;
        color: #1b1b1b;
        margin-top: 4px;
        margin-bottom: 6px; }
      /* --- Texte d‚Äôadresse et d‚Äôinfos --- */
      #p-meta {font-size: 13px; line-height: 1.35;}
      /* --- Posts Instagram (grille) --- */
      #p-photos {
        gap: 6px;
      }
      #p-photos a {
        border-radius: 6px;
        min-height: 80px;
      }
      #p-photos img {
        height: 70px;
      }
      /* --- Corps g√©n√©ral du panneau --- */
      #panel .body {
        padding: 10px 12px;  /* r√©duit l‚Äôespace int√©rieur */
        font-size: 13px;     /* texte global plus petit */
      }
      /* --- Bouton de fermeture --- */
      #panel header .close {
        width: 20px;
        height: 20px;
        font-size: 16px;
      }
    }

    /* Reviews block */
         /* Bo√Æte contenant les photos Instagram ou le message */
    #p-photos .reviews {
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 20px;
        background: #fafafa;
        overflow: hidden;
        -webkit-overflow-scrolling: touch;
        min-width: 300px; /* Largeur minimale pour la bo√Æte */
        min-height: 20px; /* Hauteur minimale pour s'assurer que la bo√Æte est suffisamment grande */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .review:last-child{ border-bottom:0; }

    .dimmed{ opacity:.35; filter:grayscale(100%); }
    .leaflet-marker-icon.highlight{ filter:drop-shadow(0 0 8px var(--brand)) saturate(1.15); transform:translateY(-1px) scale(1.05); transition:filter .15s ease,transform .15s ease; }

    /* --- Instagram photos grid --- */
    #p-photos {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    }
    #p-photos a {
    display: block;
    border-radius: 8px;
    overflow: hidden;
    min-height: 110px; 
    }
    #p-photos img {
    width: 100%;
    height: 90px;
    object-fit: cover;
    display: block;
    }
    @media (max-width: 30px){
    #p-photos { grid-template-columns: repeat(3, 1fr); }
    }

    /* Utility */
    .muted{ color:var(--muted); }

    /* Desktop-only */
    @media (min-width:769px){
      .titlechip{ display:block; }
      #leftUI{ display:grid; }
      .mobile-topbar{ display:none; }
      .reviews{ max-height:50vh; overflow:auto; }
    }

    /* Mobile layout */
    @media (max-width:768px){
      .titlechip{ display:none; }
      #cta-desktop{ display:none; }


      /* Prevent iOS auto-zoom on focus by using >=16px */
      #search input[type="text"],
      #filters input[type="text"],
      .ms-trigger{ font-size:16px; }

      #leftUI{
        left:8px; right:8px; width:auto;
        top:calc(100px + env(safe-area-inset-top, 0px));
        max-width:100%;
        overflow:visible;
      }

      .mobile-topbar{
        position:fixed; left :0 ; right:0; top:0; height:70px ; z-index:2000;
        background:#F6ECDF; border-bottom:1px solid #eee; box-shadow:0 2px 10px rgba(0,0,0,.04); 
        display:block; width: 100vw; 
      }



    /* Emp√™che le d√©bordement du fond + g√®re l'alignement interne */
        .mobile-topcard{
          /* style carte conserv√© */
          border-radius: 0;
          overflow: hidden;                 /* pas de d√©bordement du fond */
          background-clip: padding-box;     /* le fond ne passe pas sous la bordure */
          display: flex;
          flex-direction: column;
          align-items: flex-end;            /* ‚¨ÖÔ∏è contenu align√© √† DROITE */
          justify-content: flex-start;      /* ‚¨ÖÔ∏è en HAUT de la carte */
          padding : 2px 14px 10px 1px;                /* ‚¨ÖÔ∏è espace haut/droite pour ‚Äúcentrer‚Äù visuellement dans le cong√© arrondi */
          gap: 8px;
          width: 100%;
          height : 70px;
          min-width: 0;
          box-sizing: border-box;
        }

        /* Les rang√©es de boutons : √† droite, bien align√©es */
        .mobile-row,
        .mobile-toggle-row{
          display: flex !important; 
          justify-content: flex-end;        /* ‚¨ÖÔ∏è √† droite */
          align-items: center;              /* ‚¨ÖÔ∏è verticalement au milieu de la rang√©e */
          gap: 8px;
          width: 30%;
        }

        /* Ne pas √©tirer les boutons (sinon ils ‚Äútouchent‚Äù le bord) */
        .mobile-row .btn,
        .mobile-toggle-row .btn{
          flex: 1 1 80px;              /* les deux prennent chacun ~la moiti√© de la carte */
          text-align: center;
          min-width: 100px;           /* garde une largeur mini coh√©rente */
          box-sizing: border-box;
        }

        /* Le conteneur 70% √† droite reste transparent (pour √©viter le halo) */
        .mobile-topbar{
          border: 0 !important;
          border-radius: 0 !important;
        }

            /* zone logo (prend l‚Äôespace libre √† gauche) */
      .mobile-logo{
        position:fixed;
        top:0; left:0;
        width:var(--logo-col);           /* l‚Äôautre portion de l‚Äô√©cran */
        padding:6px;
        padding-top:calc(7px + env(safe-area-inset-top, 0px));
        display:flex; align-items:center; justify-content:flex-start;
        z-index:2002;         /* au-dessus de la carte */
        background:transparent;
        pointer-events:none;  /* le logo ne bloque pas les clics sur la carte */
      }
      .mobile-logo img{
            display:block;
            width:150%;                               /* s‚Äôadapte √† 20vw */
            height:auto;                              /* garde les proportions */
            max-height:80px;                          /* √©vite de recouvrir les boutons */
            object-fit:contain;
      }
      
      .mobile-row{ display:grid; grid-template-columns:1fr 1fr; gap:6px; }
      #cta-mobile .btn{ font-size:12.5px; padding:9px 10px; min-width:0; max-width:100%; }

      .mobile-toggle-row{ margin-top:5px; display:grid; grid-template-columns:1fr 1fr; gap:4px; }
      .mobile-toggle-row .btn{ background:#fff; color:#111827; border:1px solid #e5e7eb; }
      .mobile-toggle-row .btn:hover{ background:#f8f8f8; }
      .mobile-toggle-row .btn.btn-small{ padding:8px 10px; font-size:12px; }

      #search.mobile-hidden, #filters.mobile-hidden{ display:none !important; }
      #filters{ transition:none; }

      /* Bottom-sheet panel: fixed height */
      #panel{
        position:fixed; left:0; right:0; bottom:0; top:auto; width:100%;
        height:35vh;
        transform:translateY(100%); box-shadow:0 -8px 24px rgba(0,0,0,.12);
        border-top-left-radius:14px; border-top-right-radius:14px;
      }
      #panel.active{ transform:translateY(0); }
      .reviews{ max-height:none; overflow:visible; }
    }

     /* bloc en bas √† droite */
      #suggestion-btn {
    position: fixed;
    right: 10px;
    bottom: 25px;
    z-index:2000;
    background: var(--brand);
    color: #fff;
    padding: 7px 12px;
    border-radius: 8px;
    font-family: var(--font-ui);
    font-size: var(--font-size);
    text-decoration: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  #suggestion-btn:hover {
    background: var(--brand-strong);
  }

/* --- Correction affichage "aucune photo" --- */
#p-photos .reviews {
  grid-column: 1 / -1;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

#p-photos .reviews .muted {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

#p-photos .ig-card{
  position: relative;
  height: 90px;
  border-radius: 8px;
  border: 1px solid #eee;
  background: #fafafa;
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
}
#p-photos .ig-card img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
#p-photos .ig-card .ig-fallback{
  color: #374151;
  font-weight: 600;
}


  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Desktop title -->
  <div class="titlechip">
  <img src="Logo Mapping.png" alt="KittyChercheCookie" style="height:80px; object-fit:contain;">
</div>

  <!-- Desktop left column -->
  <div id="leftUI">
    <div id="cta-desktop" class="card">
      <div class="cta-row">
        <button id="toggle-search-desktop"  class="btn btn-outline">Recherche ‚ñæ</button>
        <button id="toggle-filters-desktop" class="btn btn-outline">Filtres ‚ñæ</button>
      </div>
  </div>

    <!-- Desktop SEARCH card (hidden by default) -->
    <div id="search" class="card collapsed mobile-hidden">
  <h3>Recherche</h3>

  <div class="tokenbox">
    <div id="tok-container" class="tokenlist"></div>
    <input id="f-search" type="text" placeholder="Rechercher une boutique" autocomplete="off" />
    <div id="ac" class="ac-list"></div>

    <div class="token-actions">
      <button id="clear-tokens" class="btn-clear" type="button" style="display:none;">R√©initialiser</button>
    </div>
  </div> <!-- fin .tokenbox -->

  <!-- Barre d‚Äôactions Recherche (m√™me structure que Filtres) -->
  <div class="actions" style="grid-column:1 / -1;">
    <button id="s-validate" type="button">Valider</button>
    <button id="s-reset" class="reset" type="button">R√©initialiser</button>
  </div>
</div>


    <!-- Desktop FILTERS card (hidden by default) -->
    <div id="filters" class="card collapsed mobile-hidden">
      <h3>Filtres</h3>

      <!-- FULL-CARD Lock overlay -->
      <div id="filters-overlay" aria-hidden="true">
        <div class="overlay-card"><span aria-hidden="true">üîí</span><span>Filtres d√©sactiv√©s pendant une s√©lection pr√©cise.<br/>Retirez la s√©lection pour r√©activer les filtres.</span></div>
      </div>

      <div id="filters-body">
        <!-- Rating -->
        <div class="row sliderrow">
          <label id="lbl-rating" for="f-rating">Note minimale</label>
          <div class="sliderwrap">
            <input id="f-rating" type="range" min="2" max="5" step="0.25" value="0" />
            <div><span id="f-rating-val">‚â• 0</span> ‚òÖ</div>
          </div>
        </div>


        <!-- Food -->
        <div class="row" style="grid-column:1 / -1;">
          <div class="multiselect" id="ms-food">
            <div class="ms-trigger" data-label="Cat√©gorie">
              <span id="ms-food-label">Cat√©gorie</span>
              <span class="ms-count" id="ms-food-count"></span>
            </div>
            <div class="ms-panel" id="ms-food-panel">
              <div class="ms-head">
                <span>Cat√©gorie</span>
                <span><span class="link" id="food-select-all"></span>  <span class="link" id="food-select-none"></span></span>
              </div>
            </div>
          </div>
        </div>

        <div class="actions" style="grid-column:1 / -1;">
          <button id="f-zoom">Valider</button>
          <button id="f-reset" class="reset" type="button">R√©initialiser</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile top bar -->
<div class="mobile-topbar">
  <div class="card mobile-topcard">
    <div id="cta-mobile" class="mobile-row"></div>
    <div class="mobile-toggle-row">
      <button id="toggle-search-mobile"  class="btn btn-outline btn-small">Recherche ‚ñæ</button>
      <button id="toggle-filters-mobile" class="btn btn-outline btn-small">Filtres ‚ñæ</button>
    </div>
  </div>
</div>
    <div class="mobile-logo">
    <img src="Logo Mapping.png" alt="Logo Mapping">
  </div>


  <!-- Details panel -->
  <aside id="panel">
    <header>
      <h2 id="p-title">D√©tails</h2>
      <button class="close" id="p-close" title="Fermer">√ó</button>
    </header>
    <div class="body">
      <div id="p-meta" class="meta"></div>
      <div id="p-pills"></div>
      <div class="section-title">Posts Instagram</div>
      <div id="p-photos"></div>
    </div>
  </aside>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // CSV
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRmgOK6PrjfLs6um_wppZ_qTARS_bzF5X79iVRERRNUc4Q1zvd-o1G6mu-VpP3SDzVam8NedzlkbR58/pub?gid=1938056851&single=true&output=csv";

    // Map
    const office = { lat: 48.8632196, lng: 2.3487262};
    const defaultZoom = 13;
    const map = L.map('map', { zoomControl: false }).setView([office.lat, office.lng], defaultZoom);
    L.control.zoom({ position: 'bottomleft' }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution:'&copy; OpenStreetMap & CARTO', subdomains:'abcd', maxZoom:20 }).addTo(map);

    // === Mobile : afficher les cat√©gories √† c√¥t√© du titre dans le header ===
(function(){
  const panelHeader = document.querySelector('#panel header');
  const closeBtn    = document.getElementById('p-close');
  const pillsEl     = document.getElementById('p-pills');
  const originalParent = pillsEl ? pillsEl.parentElement : null;

  if (!panelHeader || !pillsEl) return;

  function placePillsInHeader(){
    if (pillsEl.parentElement !== panelHeader){
      // on place les cat√©gories dans le header, juste avant le bouton fermer
      panelHeader.insertBefore(pillsEl, closeBtn || null);
    }
  }
  function placePillsBack(){
    if (originalParent && pillsEl.parentElement !== originalParent){
      originalParent.appendChild(pillsEl);
    }
  }
  function syncPillsPlacement(){
    if (window.matchMedia('(max-width: 768px)').matches){
      placePillsInHeader();
    } else {
      placePillsBack();
    }
  }

  // S'assurer que le placement reste correct apr√®s le rendu du panneau
  const origUpdatePanel = window.updatePanel;
  if (typeof origUpdatePanel === 'function'){
    window.updatePanel = function(row){
      const ret = origUpdatePanel.call(this, row);
      syncPillsPlacement();
      return ret;
    };
  }

  // Initial + redimensionnement
  syncPillsPlacement();
  window.addEventListener('resize', () => setTimeout(syncPillsPlacement, 50));
})();


// ===== Helpers couleur (d√©grad√© personnalisable) =====
function cssVar(name, fallback){
  const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  return v || fallback;
}
function hexToRgb(hex){
  const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  if(!m) return {r:180,g:180,b:180};
  return { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) };
}
function rgbToHex({r,g,b}){
  const h = n => n.toString(16).padStart(2,'0');
  return `#${h(r)}${h(g)}${h(b)}`;
}
function lerp(a,b,t){ return Math.round(a + (b-a)*t); }
function lerpColor(c1,c2,t){
  const A = hexToRgb(c1), B = hexToRgb(c2);
  return rgbToHex({ r: lerp(A.r,B.r,t), g: lerp(A.g,B.g,t), b: lerp(A.b,B.b,t) });
}

 //Retourne une couleur selon la note (0‚Äì5) en interpolant sur 3 stops.
 function colorFromRating(avg){
  const low  = cssVar('--mark-low');  
  const mid  = cssVar('--mark-mid');
  const mid2  = cssVar('--mark-mid2');
  const high = cssVar('--mark-high'); 
  const n = Number(avg);
  if(!Number.isFinite(n) || n <= 0) return '#9CA3AF'; 
  const clamped = Math.max(0, Math.min(5, n));
  if (clamped <= 2) {
    return low;
  } else if (clamped <= 3) {
    const t = (clamped - 2) / (3 - 2); 
    return lerpColor(low, mid, t);
  } else if (clamped <= 4) {
    const t = (clamped - 3) / (4 - 3); 
    return lerpColor(mid, mid2, t);
  } else {
    const t = (clamped - 4) / (5 - 4); 
    return lerpColor(mid2, high, t);
  }
}


// ===== Ic√¥ne Leaflet (identique, mais utilise la nouvelle couleur) =====
function makeRestIcon(avg){
  const num = Number(avg);
  const label = (Number.isFinite(num) && num > 0) ? num.toFixed(1) : 'n.a';
  const color = colorFromRating(num);

  const svg = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
  <path fill="${color}" d="M128 252.6C128 148.4 214 64 320 64C426 64 512 148.4 512 252.6C512 371.9 391.8 514.9 341.6 569.4C329.8 582.2 310.1 582.2 298.3 569.4C248.1 514.9 127.9 371.9 127.9 252.6z"/>
  <circle cx="320" cy="245" r="120" fill="white" opacity="0.97"/>
  <text x="320" y="282" text-anchor="middle"
        font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif"
        font-size="130" font-weight="400" fill="#000000">${label}</text>
</svg>`.trim();
  return L.icon({
    iconUrl: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
    iconSize: [36,50],
    iconAnchor: [18,48],
    popupAnchor: [0,-44]
  });
}

    // ====== State ======
    const all = { data: [], markers: [] };
    let selectedMarker = null; 
    let selectedName = null;

    // ====== Helpers ======
    const toNum = v => { const n=parseFloat(String(v).replace(',', '.')); return Number.isFinite(n)?n:null; };
    const norm  = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
    const keyOf = r => `${(r.restaurant_name||'').trim()} ‚Äî ${(r.restaurant_adress||'').trim()}`;
    const nameOf = r => String(r.restaurant_name || '').trim();

    function avgStarsHtml(avg){
      const n=Number(avg);
      if(!Number.isFinite(n) || n<=0) return 'n.a';
      const k=Math.max(0,Math.min(5,Math.round(n)));
      const filled=`<span style="color:var(--star-gold)">‚òÖ</span>`.repeat(k);
      const empty =`<span style="color:var(--star-grey)">‚òÖ</span>`.repeat(5-k);
      const num=`<span class="muted">(${n.toFixed(1)}/5)</span>`;
      return filled+empty+' '+num;
    }

    function simplePopup(row) {
    const name = row.restaurant_name || '';
    const addr = row.restaurant_adress || '';
    const avg = row.avg_rating;

  // Calcul du nombre de posts Instagram
  const rawInstagramPhotos = (row.instagram_photos || '').trim();  // R√©cup√®re la colonne instagram_photos
  const instagramUrls = rawInstagramPhotos
    .split(/[;,|]/)  // S√©pare les diff√©rents liens par ;, , ou |
    .map(u => u.trim())
    .filter(Boolean); 

  const photoCnt = instagramUrls.length;  // Nombre de posts Instagram

  // Affichage du nombre de posts dans le popup
  const rating = (Number(avg) > 0)
    ? `${avgStarsHtml(avg)} <span class="muted">¬∑ ${photoCnt} ${photoCnt > 1 ? 'posts' : 'post'}</span>`
    : `<span class="muted">n.a ¬∑ ${photoCnt} ${photoCnt > 1 ? 'posts' : 'post'}</span>`;

  return `<div style="min-width:220px"><b>${name}</b><br/>${addr}<br/>${rating}</div>`;
}


    //Photo insta
    function renderInstagramPhotos(row){
    const raw = (row.instagram_photos || '').trim();
    if (!raw) return emptyBox();

    const urls = raw
        .split(/[;,|]/)
        .map(u => u.trim())
        .filter(Boolean)
        .slice(0, 24);

    if (!urls.length) return emptyBox();
    const photoCount = urls.length;
    const cells = urls.map(u => {
        const safe = u.replace(/"/g, '&quot;');

        if (isInstagramPostUrl(u)) {
            // Lien vers un post (non une image) - on r√©cup√®re l'image du post
            return `
                <a href="${safe}" target="_blank" rel="noopener" class="ig-card">
                    <div class="ig-embed">
                        <iframe src="https://www.instagram.com/p/${getInstagramPostId(u)}/embed" 
                                width="160" 
                                height="300" 
                                frameborder="0" 
                                scrolling="no" 
                                allowtransparency="false">
                        </iframe>
                    </div>
                </a>`;
        }

        if (isImageUrl(u)) {
            // Lien direct vers une image
            return `
                <a href="${safe}" target="_blank" rel="noopener" class="ig-card">
                    <img
                        src="${safe}"
                        referrerpolicy="no-referrer"
                        loading="lazy"
                        alt="Photo Instagram"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                        onload="this.nextElementSibling.style.display='none';"
                    />
                    <span class="ig-fallback">Voir le post Instagram</span>
                </a>`;
        }

        // Autre type d'URL ‚Äî on ignore
        return '';
    }).join('');

    return cells || emptyBox();

    // Fonctions utilitaires internes
    function emptyBox(){
        return '<div class="reviews"><div class="muted">Aucun post pour le moment.</div></div>';
    }

    // Fonction pour obtenir l'ID d'un post Instagram
    function getInstagramPostId(url){const match = url.match(/instagram\.com\/(?:p|reel|tv)\/([a-zA-Z0-9-_]+)/); return match ? match[1] : '';}
    function isImageUrl(u){ return /\.(jpg|jpeg|png|webp|gif)(\?|#|$)/i.test(u) }
    function isInstagramPostUrl(u){ return /instagram\.com\/(p|reel|tv)\//i.test(u); }
    }

    // D√©coupe "Italien, Pizzeria; Sushi | Vegan" -> ["Italien","Pizzeria","Sushi","Vegan"]
    function parseFoodTypes(s){
      return String(s||'')
        .split(/[;,|]/)               // s√©parateurs autoris√©s
        .map(t => t.trim())
        .filter(Boolean)
        .slice(0,4);                  // max 4
    }

    function renderReviews(htmlOrText){
      if(!htmlOrText) return '<div class="muted">Aucun post pour le moment.</div>';
      const hasTag=/<\w+[^>]*>/.test(htmlOrText);
      if(hasTag) return htmlOrText;
      const safe=String(htmlOrText).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      return safe.split(/\n{2,}/).map(b=>`<div class="review">${b.replace(/\n/g,'<br/>')}</div>`).join('');
    }

    function updatePanel(row) {
  document.getElementById('p-title').innerText = row.restaurant_name || '';

  const meta = [];

  // Ajout de l'adresse du restaurant
  if (row.restaurant_adress) meta.push(row.restaurant_adress);

  // R√©cup√©rer et compter les posts Instagram
  const rawInstagramPhotos = (row.instagram_photos || '').trim();  // R√©cup√®re la colonne instagram_photos
  const instagramUrls = rawInstagramPhotos
    .split(/[;,|]/)  // S√©pare les diff√©rents liens par ;, , ou |
    .map(u => u.trim())
    .filter(Boolean);  

  const photoCnt = instagramUrls.length;  // Nombre de posts Instagram

  // Calcul de l'√©valuation (Note moyenne)
  const ratingStr = (Number(row.avg_rating) > 0)
    ? `${avgStarsHtml(row.avg_rating)} ¬∑ ${photoCnt} ${photoCnt > 1 ? 'posts' : 'post'}`
    : `n.a ¬∑ ${photoCnt} ${photoCnt > 1 ? 'posts' : 'post'}`;

  meta.push(ratingStr);  // Ajoute l'√©valuation et le nombre de posts √† l'affichage

  // Mise √† jour de la section 'meta' avec ces informations
  document.getElementById('p-meta').innerHTML = meta.map(m => `<div>${m}</div>`).join('');

  // Tags cuisine
  const pills = [];
  const foodTags = Array.isArray(row.food_types) ? row.food_types : parseFoodTypes(row.food_type);
  foodTags.forEach(t => pills.push(`<span class="pill">${t}</span>`));
  document.getElementById('p-pills').innerHTML = pills.join(' ');

  // Photos Instagram
  document.getElementById('p-photos').innerHTML = renderInstagramPhotos(row);

  // Activer le panneau
  document.getElementById('panel').classList.add('active');
  setTimeout(() => map.invalidateSize(), 60);
}


    function clearSelection(){
      selectedName = null;
      selectedMarker=null;
      all.markers.forEach(m=>m.marker.getElement()?.classList.remove('highlight'));
      document.getElementById('panel').classList.remove('active');
      map.closePopup();
      setTimeout(()=>map.invalidateSize(),60);
      closeAC(); // Only close autocomplete, NOT multiselects
    }
    document.getElementById('p-close').addEventListener('click', clearSelection);
    map.on('click', (e)=>{
      if(!e.originalEvent.target.closest('.leaflet-marker-icon') && !e.originalEvent.target.closest('.leaflet-popup')) clearSelection();
    });

    function enableHoverPinBehavior(marker,row=null){
      marker._pinned=false;
      marker.on('mouseover',function(){ if(!this._pinned) this.openPopup(); });
      marker.on('mouseout', function(){ if(!this._pinned) this.closePopup(); });
      marker.on('click',function(ev){
        const nowPinned=!this._pinned;
        all.markers.forEach(m=>{ m.marker._pinned=false; m.marker.getElement()?.classList.remove('highlight'); });
        if(nowPinned){ this._pinned=true; this.openPopup(); this.getElement()?.classList.add('highlight'); if(row) updatePanel(row); selectedMarker=this; }
        else clearSelection();
        ev.originalEvent?.stopPropagation?.();
      });
    }

    function selectMarkersByName(name){
      selectedName = name;
      const bounds = L.latLngBounds();
      let count = 0;
      all.markers.forEach(({ marker, data }) => {
        if (nameOf(data) === name) {
          const el = marker.getElement();
          el?.classList.add('highlight');
          el?.classList.remove('dimmed'); // au cas o√π
          bounds.extend(marker.getLatLng());
          count++;
        }
      });
      applyFilters(false);
      if (count > 1) {
        map.fitBounds(bounds.pad(0.15), { maxZoom: 17 });
      } else if (count === 1) {
        map.fitBounds(bounds.pad(0.08), { maxZoom: 17 });
      }
      syncFiltersLock();
    }

      function selectMarkerByKey(key){
      const entry = all.markers.find(m => m.key === key);
      if(!entry) return;

      // D√©pinner et retirer le highlight des autres
      all.markers.forEach(m => {
        m.marker._pinned = false;
        m.marker.getElement()?.classList.remove('highlight');
      });

      const { marker, data } = entry;

      marker._pinned = true;
      selectedMarker = marker;

      // Affichage & UI
      marker.openPopup();
      marker.getElement()?.classList.add('highlight');
      marker.getElement()?.classList.remove('dimmed'); // au cas o√π
      updatePanel(data);

      // recadrer un peu sur la boutique
      map.setView(marker.getLatLng(), Math.max(map.getZoom(), 15));
    }

    // ---------- UI refs ----------
    const filtersBox = document.getElementById('filters');
    const searchBox  = document.getElementById('search');

    const elSearch   = document.getElementById('f-search');
    const elTokBox   = document.getElementById('tok-container');
    const elAC       = document.getElementById('ac');

    const clearTokensBtn = document.getElementById('clear-tokens');

    const elRating    = document.getElementById('f-rating');
    const elRatingVal = document.getElementById('f-rating-val');

    const msFood         = document.getElementById('ms-food');
    const msFoodTrig     = msFood.querySelector('.ms-trigger');
    const msFoodPanel    = document.getElementById('ms-food-panel');
    const msFoodCount    = document.getElementById('ms-food-count');
    const foodSelectAll  = document.getElementById('food-select-all');
    const foodSelectNone = document.getElementById('food-select-none');

    const elZoomBtn  = document.getElementById('f-zoom');
    const elResetBtn = document.getElementById('f-reset');

    const toggleFiltersDesktopBtn = document.getElementById('toggle-filters-desktop');
    const toggleSearchDesktopBtn  = document.getElementById('toggle-search-desktop');


        function closeFiltersPanel(){
  // Ferme les popovers √©ventuels
  closeAllMS();
  // Fermer / masquer la carte des filtres selon le mode
  if (window.matchMedia('(max-width: 768px)').matches){
    // mobile : masquer la section
    showFiltersMobile(false);
  } else {
    // desktop : collapse
    if (!filtersBox.classList.contains('collapsed')){
      filtersBox.classList.add('collapsed');
    }
    syncDesktopToggleLabels();
  }
  setTimeout(()=>map.invalidateSize(), 60);
}


// === Mode inline du multiselect sur mobile ===
function isMobile(){ 
  return window.matchMedia('(max-width: 768px)').matches; 
}

function syncCategoryInlineMode(){
  if (isMobile()){
    // Passe le multiselect Cat√©gorie en mode inline
    msFood.classList.add('inline-mobile');
    // s'assurer qu'aucune logique "popover" ne s'active
    msFood.classList.remove('open');
    filtersBox.classList.remove('raise');
  } else {
    // Retour au comportement desktop (panneau flottant)
    msFood.classList.remove('inline-mobile');
  }
}

// Emp√™che l'ouverture/fermeture du panneau quand il est inline
msFoodTrig.addEventListener('click', (e)=>{
  if (msFood.classList.contains('inline-mobile')){
    e.preventDefault();
    e.stopPropagation();
    return; // rien √† ouvrir/fermer : la liste est d√©j√† visible
  }
  // sinon, on garde ton comportement existant :
  e.preventDefault();
  e.stopPropagation();
  toggleMS(msFood);
});

// Appels au bon moment
syncCategoryInlineMode();

// Quand la vue mobile/desktop change
window.addEventListener('resize', ()=>{
  setTimeout(()=>{
    syncCategoryInlineMode();
  }, 50);
});

    // Mobile toggles
    const toggleSearchMobileBtn  = document.getElementById('toggle-search-mobile');
    const toggleFiltersMobileBtn = document.getElementById('toggle-filters-mobile');

    // Values
    let foodValues  = [];

    /* ===== Multiselect toggle (inline; no portal) ===== */
    let currentOpenMS = null; // HTMLElement of .multiselect
    function openMS(container){
      if (container.classList.contains('inline-mobile')) return;
        if(filtersBox.classList.contains('locked')) return;
      if(currentOpenMS && currentOpenMS !== container){
        currentOpenMS.classList.remove('open');
      }
      container.classList.add('open');
      filtersBox.classList.add('raise');
      currentOpenMS = container;
    }
    function closeMS(container){
      if(!container) return;
      container.classList.remove('open');
      if(currentOpenMS === container) currentOpenMS = null;
      if(!currentOpenMS) filtersBox.classList.remove('raise');
    }
    function toggleMS(container){
      if(filtersBox.classList.contains('locked')){ closeAllMS(); return; }
     if (container.classList.contains('inline-mobile')) return;
      if(container.classList.contains('open')) closeMS(container);
      else openMS(container);
    }
    function closeAllMS(){
      document.querySelectorAll('.multiselect.open').forEach(ms=>ms.classList.remove('open'));
      currentOpenMS = null;
      filtersBox.classList.remove('raise');
    }

    // Triggers
    msFoodTrig .addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); toggleMS(msFood);  });

    // Click outside to close (mousedown intercept)
    document.addEventListener('mousedown', (e)=>{
      if(currentOpenMS && !currentOpenMS.contains(e.target)) closeAllMS();
    });

    // ESC to close
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeAllPopovers(); });

    // Prevent bubbling inside panels
    function addPanelEventIsolation() {
      document.querySelectorAll('.ms-panel').forEach(panel => {
        panel.addEventListener('mousedown', e => e.stopPropagation());
        panel.addEventListener('click',     e => e.stopPropagation());
        panel.addEventListener('mouseup',   e => e.stopPropagation());
      });
    }

    /* ===== Autocomplete (inline; no portal) ===== */
    function openAC(){ elAC.style.display='block'; searchBox.classList.add('raise'); }
    function closeAC(){ elAC.style.display='none'; searchBox.classList.remove('raise'); }
    function updateACList(){
      const q = norm(elSearch.value);
      if (!q){ closeAC(); elAC.innerHTML=''; return; }
      const names = Array.from(
        new Set(
          all.data
            .map(nameOf)
            .filter(n => n && norm(n).includes(q))
        )
      ).slice(0, 20);
      if (!names.length){ closeAC(); elAC.innerHTML=''; return; }
      elAC.innerHTML = names
        .map(n => `<div class="ac-item" data-name="${n}">${n}</div>`)
        .join('');
      openAC();
    }
    elSearch.addEventListener('input', updateACList);
    elSearch.addEventListener('focus', updateACList);
    elSearch.addEventListener('blur', ()=>{ setTimeout(()=>closeAC(), 120); });
    document.addEventListener('click', (e)=>{ if(!elAC.contains(e.target) && e.target!==elSearch) closeAC(); });
    elAC.addEventListener('click',(e)=>{
      const it = e.target.closest('.ac-item'); 
      if(!it) return;
      const name = it.dataset.name;
      elSearch.value = name;
      closeAC();
      selectedKeys.clear();
      renderTokens();
      selectMarkersByName(name);
    });

    // Multi-select state
    const selectedFoods  = new Set();
    const selectedKeys   = new Set(); // kept for tokens UX
    function updateMSCount(countEl,selectedSet,values){
      if(selectedSet.size===0) countEl.textContent='';
      else if(selectedSet.size===values.length) countEl.textContent='(tous)';
      else countEl.textContent=`(${selectedSet.size})`;
    }
    function renderMS(panel, values, selectedSet, countEl){
      panel.querySelectorAll('.ms-opt').forEach(n=>n.remove());
      values.forEach(v=>{
        const id=`${panel.id}-${v}`;
        const row=document.createElement('label');
        row.className='ms-opt';
        row.innerHTML=`<input type="checkbox" id="${id}" ${selectedSet.has(v)?'checked':''}/> <span>${v}</span>`;
        panel.appendChild(row);
        const checkbox = row.querySelector('input');
        checkbox.addEventListener('change',(ev)=>{
          if(ev.target.checked) selectedSet.add(v); else selectedSet.delete(v);
          updateMSCount(countEl,selectedSet,values);
          resetSearchIfActive();
          applyFilters(true);
        });
        row.addEventListener('mousedown', (ev) => ev.stopPropagation());
        row.addEventListener('click',     (ev) => ev.stopPropagation());
        row.addEventListener('mouseup',   (ev) => ev.stopPropagation());
      });
      updateMSCount(countEl,selectedSet,values);
      addPanelEventIsolation();
    }

    // Slider UI
    function setRangeFill(rangeEl){
      const min=parseFloat(rangeEl.min||0), max=parseFloat(rangeEl.max||1), val=parseFloat(rangeEl.value||0);
      const pct=((val-min)/(max-min))*100; rangeEl.style.backgroundSize=pct+'% 100%';
    }
    function updateRatingLabel(){
      const v=parseFloat(elRating.value);
      elRatingVal.textContent='‚â• '+(Number.isInteger(v)?v.toFixed(0):v.toFixed(1));
      setRangeFill(elRating);
    }
    updateRatingLabel();
    setRangeFill(elRating);
    elRating.addEventListener('input',()=>{ updateRatingLabel(); resetSearchIfActive(); applyFilters(false); });

    // Tokens (kept)
  function renderTokens(){
  elTokBox.innerHTML = '';

  // Affiche le petit "R√©initialiser" UNIQUEMENT si n√©cessaire
  const hasQueryOrTokens = selectedKeys.size > 0 || elSearch.value.trim() !== '';
  clearTokensBtn.style.display = hasQueryOrTokens ? 'inline-block' : 'none';
  clearTokensBtn.textContent = 'R√©initialiser';
}

      clearTokensBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    resetToInitialState();   // ta fonction de reset global
  });
    function lockFilters(){ filtersBox.classList.add('locked'); /* Don't close multiselects when locking */ }
    function unlockFilters(){ filtersBox.classList.remove('locked'); }
    function syncFiltersLock(){ if (selectedName || selectedKeys.size > 0) lockFilters(); else unlockFilters();}

    function resetFiltersToDefaultIfUsed(){
      let changed=false;
      if (parseFloat(elRating.value)!==0){ elRating.value=0; updateRatingLabel(); changed=true; }
      if (selectedFoods.size){ selectedFoods.clear(); changed=true; }
      if (changed){
        renderMS(msFoodPanel, foodValues, selectedFoods, msFoodCount);
      }
      return changed;
    }
    function resetSearchIfActive(){
      let changed=false;
      if (selectedKeys.size){ selectedKeys.clear(); changed=true; }
      if (elSearch.value.trim()!==''){ elSearch.value=''; closeAC(); changed=true; }
      if (changed){ renderTokens(); unlockFilters(); }
      return changed;
    }

    /* === Safer "Tout/Aucun" using live arrays (no stale closures) === */
    [foodSelectAll, foodSelectNone].forEach(el => {
      if(el){
        el.addEventListener('mousedown', e => e.stopPropagation());
        el.addEventListener('mouseup',   e => e.stopPropagation());
      }
    });

    function selectAll(which){
      return (e)=>{
        e.preventDefault(); e.stopPropagation();
        set.clear();
        values.forEach(v => set.add(v));
        renderMS(panel, values, set, countEl);
        resetSearchIfActive();
        applyFilters(true);
      };
    }
    function selectNone(which){
      return (e)=>{
        e.preventDefault(); e.stopPropagation();
        set.clear();
        renderMS(panel, values, set, countEl);
        resetSearchIfActive();
        applyFilters(true);
      };
    }

    foodSelectAll  .addEventListener('click', selectAll('food'));
    foodSelectNone .addEventListener('click', selectNone('food'));

    // Filtering
    function passFilters(row) { 
      if (selectedName) { const rowName = nameOf(row); if (rowName !== selectedName) return false; } 
      if (selectedKeys.size) { if (!selectedKeys.has(keyOf(row))) return false; } 
      else { const q = norm(elSearch.value); if (q) { const hay = norm((row.restaurant_name || '') + ' ' + (row.restaurant_adress || '')); if (!hay.includes(q)) return false; } } 
      const minRating = parseFloat(elRating.value); const avg = Number(row.avg_rating); 
      if (minRating > 0) { if (!Number.isFinite(avg) || avg < minRating) return false; } 
      if (selectedFoods.size) { const tags = Array.isArray(row.food_types) ? row.food_types : parseFoodTypes(row.food_type); const hasAny = tags.some(t => selectedFoods.has(t)); if (!hasAny) return false; } 
      return true; 
    }

    function applyFilters(resetSelection = false) { 
      if (resetSelection) clearSelection(); 
      all.markers.forEach(({ marker, data }) => { 
        const el = marker.getElement(); if (!el) return; 
        if (el.classList.contains('highlight')) { el.classList.remove('dimmed'); return; } 
        if (selectedMarker && selectedMarker === marker) { el.classList.remove('dimmed'); } 
        else { if (passFilters(data)) { el.classList.remove('dimmed'); } else { el.classList.add('dimmed'); } } 
      }); 
    }

    function fitToFiltered(){
      const bounds=L.latLngBounds(); let added=0;
      all.markers.forEach(({marker})=>{
        const el=marker.getElement();
        if(el && !el.classList.contains('dimmed')){ bounds.extend(marker.getLatLng()); added++; }
      });
      if(added>0) map.fitBounds(bounds.pad(0.1),{maxZoom:17});
    }

      // Fonction de r√©initialisation compl√®te 
function resetToInitialState(){
  selectedKeys.clear();
  renderTokens();
  elSearch.value = '';
  closeAC();
  unlockFilters();
  elRating.value = 0;
  updateRatingLabel();
  selectedFoods.clear();
  renderMS(msFoodPanel, foodValues, selectedFoods, msFoodCount);
  closeAllMS();
  clearSelection(); 
  applyFilters(false);
  map.setView([office.lat, office.lng], defaultZoom);
  setTimeout(()=>map.invalidateSize(), 60);
}

// === Bouton "D√©s√©lectionner tout" ===
clearTokensBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  resetToInitialState();
});

    // Reset & Zoom
    elResetBtn.addEventListener('click', (e)=>{
  e.preventDefault();       // emp√™che les effets par d√©faut
  e.stopPropagation();      // emp√™che de d√©clencher autre chose
  elSearch.value=''; 
  closeAC(); 
  selectedKeys.clear(); 
  renderTokens();
  elRating.value=0;  
  updateRatingLabel(); 
  selectedFoods.clear();
  renderMS(msFoodPanel, foodValues, selectedFoods, msFoodCount);
  closeAllMS();
  unlockFilters(); 
  applyFilters(true);
  map.setView([office.lat, office.lng], defaultZoom);
  closeAllPanels();          // üëà ferme aussi Recherche et Filtres
  document.activeElement?.blur(); // retire le focus visuel
  setTimeout(()=>map.invalidateSize(),60);
});
    elZoomBtn.addEventListener('click',()=>{ applyFilters(false);  map.setView([office.lat, office.lng], defaultZoom); closeFiltersPanel();
 });

 // --- Helper : fermeture du panneau Recherche ---
function closeSearchPanel(){
  closeAC(); // ferme l‚Äôautocomplete
  if (window.matchMedia('(max-width: 768px)').matches){
    // mobile : masquer la section
    showSearchMobile(false);
  } else {
    // desktop : collapse si ouvert
    if (!searchBox.classList.contains('collapsed')){
      searchBox.classList.add('collapsed');
    }
    syncDesktopToggleLabels();
  }
  setTimeout(()=>map.invalidateSize(), 60);
}

// --- Ferme les deux panneaux Recherche et Filtres (desktop + mobile) ---
function closeAllPanels(){
  closeAllMS();
  closeAC();

  if (window.matchMedia('(max-width: 768px)').matches){
    showSearchMobile(false);
    showFiltersMobile(false);
  } else {
    if (!searchBox.classList.contains('collapsed'))  searchBox.classList.add('collapsed');
    if (!filtersBox.classList.contains('collapsed')) filtersBox.classList.add('collapsed');
    syncDesktopToggleLabels();
  }

  // tr√®s utile contre les ‚Äúeffets de halo‚Äù focus/outline sur un bouton
  document.activeElement?.blur();
  setTimeout(()=>map.invalidateSize(), 60);
}

// --- Boutons Recherche ---
const elSearchValidate = document.getElementById('s-validate');
const elSearchReset    = document.getElementById('s-reset');

elSearchValidate?.addEventListener('click', ()=>{
  applyFilters(false);
  map.setView([office.lat, office.lng], defaultZoom);
  closeSearchPanel();
});

elSearchReset?.addEventListener('click', (e)=>{
  e.preventDefault();
  e.stopPropagation();
  selectedKeys.clear();
  renderTokens();
  elSearch.value = '';
  closeAC();
  unlockFilters();
  applyFilters(true);
  map.setView([office.lat, office.lng], defaultZoom);
  closeAllPanels();               
  document.activeElement?.blur(); 
  setTimeout(()=>map.invalidateSize(),60);
});
    // Desktop visibility toggles
    function toggleFiltersDesktop(){
      const collapsed = filtersBox.classList.toggle('collapsed');
      if(collapsed) closeAllMS();
      toggleFiltersDesktopBtn.textContent = collapsed ? 'Filtres ‚ñæ' : 'Masquer les filtres ‚ñ¥';
      setTimeout(()=>map.invalidateSize(),60);
    }
    function toggleSearchDesktop(){
      closeAC();
      const collapsed = searchBox.classList.toggle('collapsed');
      toggleSearchDesktopBtn.textContent = collapsed ? 'Recherche ‚ñæ' : 'Masquer la recherche ‚ñ¥';
      setTimeout(()=>map.invalidateSize(),60);
    }
    toggleFiltersDesktopBtn?.addEventListener('click', toggleFiltersDesktop);
    toggleSearchDesktopBtn ?.addEventListener('click', toggleSearchDesktop);

    function syncDesktopToggleLabels(){
      toggleSearchDesktopBtn.textContent  = searchBox.classList.contains('collapsed')  ? 'Recherche ‚ñæ' : 'Masquer la recherche ‚ñ¥';
      toggleFiltersDesktopBtn.textContent = filtersBox.classList.contains('collapsed') ? 'Filtres ‚ñæ'   : 'Masquer les filtres ‚ñ¥';
    }

    // Mobile toggles
    function setToggleLabel(btn, isVisible, noun){
      btn.textContent = noun + (isVisible ? ' ‚ñ¥' : ' ‚ñæ');
    }
    function showSearchMobile(show){
      if(show) searchBox.classList.remove('collapsed');
      searchBox.classList.toggle('mobile-hidden', !show);
      if(!show) closeAC();
      setToggleLabel(toggleSearchMobileBtn, show, 'Recherche');
      setTimeout(()=>map.invalidateSize(),30);
    }
    function showFiltersMobile(show){
      if(show) filtersBox.classList.remove('collapsed');
      filtersBox.classList.toggle('mobile-hidden', !show);
      setToggleLabel(toggleFiltersMobileBtn, show, 'Filtres');
      setTimeout(()=>map.invalidateSize(),30);
    }
    function initMobileView(){
      if (window.matchMedia('(max-width: 768px)').matches){
        const searchVisible  = !searchBox.classList.contains('mobile-hidden');
        const filtersVisible = !filtersBox.classList.contains('mobile-hidden');
        setToggleLabel(toggleSearchMobileBtn,  searchVisible,  'Recherche');
        setToggleLabel(toggleFiltersMobileBtn, filtersVisible, 'Filtres');
      } else {
        searchBox.classList.remove('mobile-hidden');
        filtersBox.classList.remove('mobile-hidden');
        syncDesktopToggleLabels();}
    }
        toggleSearchMobileBtn?.addEventListener('click', ()=>{
      const nowVisible = searchBox.classList.contains('mobile-hidden');
      showSearchMobile(nowVisible);
      setToggleLabel(toggleSearchMobileBtn, nowVisible, 'Recherche');
    });
    toggleFiltersMobileBtn?.addEventListener('click', ()=>{
      const nowVisible = filtersBox.classList.contains('mobile-hidden');
      showFiltersMobile(nowVisible);
      setToggleLabel(toggleFiltersMobileBtn, nowVisible, 'Filtres');
    });
    function closeAllPopovers(){ closeAC(); closeAllMS(); }

    // Resize -> close autocomplete and sync labels
    window.addEventListener('resize',()=>{ 
      closeAC();
      setTimeout(()=>{ initMobileView(); syncDesktopToggleLabels(); map.invalidateSize(); }, 60); 
    });

    // Data load
    Papa.parse(csvUrl,{
      download:true, header:true, skipEmptyLines:true,
      complete:function(results){
        const data=results.data||[]; all.data=data;
        const foodSet  = new Set();
        data.forEach(r => {
          r.food_types = parseFoodTypes(r.food_type);
          r.food_types.forEach(ft => foodSet.add(ft));
        });
        foodValues  = Array.from(foodSet).sort((a,b)=>a.localeCompare(b));
        renderMS(msFoodPanel, foodValues, selectedFoods, msFoodCount);
        addPanelEventIsolation();
        const bounds = L.latLngBounds();
        data.forEach(row=>{
          const lat=toNum(row.lat), lng=toNum(row.long);
          if(lat==null || lng==null) return;
          const icon=makeRestIcon(Number(row.avg_rating));
          const marker=L.marker([lat,lng],{icon}).addTo(map).bindPopup(simplePopup(row));
          enableHoverPinBehavior(marker,row);
          all.markers.push({marker,data:row,key:keyOf(row)});
          bounds.extend([lat,lng]);  // <- √©tend les limites pour inclure ce marqueur
          });
       if (!all.markers.length) {
          map.setView([office.lat, office.lng], defaultZoom);
        }
        updateRatingLabel(); applyFilters(false);
        syncDesktopToggleLabels();
        initMobileView();
        setTimeout(()=>map.invalidateSize(),60);
      },
      error:function(err){ console.error("Erreur de chargement du CSV:", err); }
    });
  </script>
  <a id="suggestion-btn" class="btn" target="_blank" rel="noopener"
   href="https://docs.google.com/forms/d/e/1FAIpQLScdts5SkpdBCrA6kztViRZJZlWkGzk_ziLOlr0MVxMzJQb83Q/viewform">
  Une suggestion ?
</a>
</body>
</html>
